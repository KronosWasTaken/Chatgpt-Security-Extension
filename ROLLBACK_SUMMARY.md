# Rollback Summary - File Scanning Restoration

**Date:** 2025-01-03

## Objective
Restore file scanning functionality to last known stable state where files were correctly intercepted, validated, and passed to backend API endpoint `/scan/file`.

## Changes Made

### 1. Simplified FileGuard Precheck Logic
- **Removed:** Server-side precheck (`/scan/validate` endpoint check)
- **Kept:** Minimal client-side precheck (size validation only - 32MB max)
- **Rationale:** Backend handles all validation (size, MIME, magic bytes). Client-side should only prevent obviously oversized files to avoid wasting bandwidth.

### 2. Removed UploadToken Parameter
- **Removed:** `uploadToken` parameter from `FileGuard.scanFile()`
- **Removed:** `uploadToken` parameter from `BackendApiService.scanFile()`
- **Removed:** `uploadToken` from FormData payload
- **Rationale:** Server precheck endpoint doesn't exist in stable state. Simplified flow by removing unused complexity.

### 3. Preserved File MIME Type
- **Kept:** Original file MIME type preservation when reconstructing File object in background script
- **Changed:** Background script uses `request.fileType` instead of hardcoded `'application/octet-stream'`
- **Rationale:** Ensures backend receives correct MIME type for proper validation.

### 4. Streamlined Event Flow
```
File Input (onChange) 
  → FileUploadMonitor.attachListenerToInput() 
  → FileGuard.handleFileUpload() 
  → FileGuard.processFile() 
  → Client Precheck (size only) 
  → FileGuard.scanFile() 
  → chrome.runtime.sendMessage('SCAN_FILE') 
  → Background Script 
  → BackendApiService.scanFile() 
  → POST /api/v1/scan/file (multipart/form-data) 
  → Backend Validation 
  → Response 
  → Real-time Logs (FILE_ANALYSIS)
```

## Files Modified

1. **extension/src/guards/FileGuard.ts**
   - Removed `runServerPrecheck()` method
   - Simplified `processFile()` to skip server precheck
   - Removed `uploadToken` parameter from `scanFile()`
   - Kept minimal client precheck (size validation only)

2. **extension/src/services/BackendApiService.ts**
   - Removed `uploadToken` parameter from `scanFile()`
   - Removed `uploadToken` from FormData payload
   - Kept all other FormData fields (file, fileName, text, clientId, mspId, correlationId)

3. **extension/src/background/index.ts**
   - Removed `uploadToken` handling from SCAN_FILE message
   - Preserved file MIME type when reconstructing File object
   - Kept BackendApiService integration unchanged

## FormData Payload (Restored)
```javascript
{
  file: Blob/File,           // Required - the file binary
  fileName: string,          // Required - original filename
  text?: string,             // Optional - extracted file text
  clientId?: string,         // Optional - from config
  mspId?: string,            // Optional - from config
  correlationId?: string     // Optional - UUID for tracking
}
```

## Headers (Unchanged)
```
Authorization: Bearer <token>
X-Correlation-Id: <uuid>
Content-Type: multipart/form-data; boundary=<auto-generated>
```

## API Contract (Restored)
- **Endpoint:** `POST {API_BASE}/api/v1/scan/file`
- **Method:** `POST`
- **Content-Type:** `multipart/form-data` (auto-generated boundary)
- **Auth:** `Bearer <token>` from `authUser` storage
- **Response:** JSON with `FileScanResponse` format

## Validation Flow (Restored)
1. **Client-side:** Size check only (32MB max) - blocks before upload
2. **Backend-side:** Full validation (size, MIME, magic bytes, sensitive data scanning) - blocks if fails

## Logging (Unchanged)
- Real-time FILE_ANALYSIS logs appear in unified panel with PROMPT_ANALYSIS logs
- Logs include: timestamp, correlationId, logType, fileName, status, summary, riskLevel
- Success and failure logs both displayed
- No layout changes or DOM structure modifications

## Acceptance Tests (Ready)
1.  File input interception works
2.  Files sent to `/scan/file` endpoint
3.  UI blocks upload until validation returns
4.  Logs appear in unified panel
5.  PromptGuard flow intact (no regressions)

## Notes
- No manifest.json changes needed
- No UI structure changes
- No dependency changes
- Backward compatible with existing backend API
- Minimal validation on client ensures files reach backend for proper processing

